% latexmk -pdflatex='pdflatex %O %S' -pvc -pdf modal_descent.tex
\documentclass[9pt,twosided]{amsart}

\usepackage{hott}


\newcommand{\shape}{\int}
\newcommand{\drawpb}[1]{\arrow[#1, phantom, "\text{\scriptsize(pb)}" description]}
\newcommand{\bC}{\mathbb C}
\newcommand{\bD}{\mathbb D}
\newcommand{\bN}{\mathbb N}
\newcommand{\bR}{\mathbb R}
\newcommand{\bZ}{\mathbb Z}
\newcommand{\bP}{\mathbb P}
\newcommand{\bA}{\mathbb A}
\newcommand{\bS}{\mathbb S}
\newcommand{\Zar}{\ensuremath{\mathrm{Zar}}}
\newcommand{\FSGrpOne}{\ensuremath{\mathsf{FSGrp}_1}}
\newcommand{\FSGrp}{\ensuremath{\mathsf{FSGrp}}}
\newcommand{\Spaces}{\ensuremath{\mathsf{Spaces}}}

\addbibresource{literatur.bib}



\title{Modal descent}
\author{Egbert Rijke and Felix Wellen}
\date{\today}


\begin{document}

\maketitle

\begin{abstract}
We show that there is a second orthogonal factorization system associated to any modality, of which the left class is the class of $\modal$-equivalences and the right class is the class of $\modal$-\'etale maps. In the special case of the $n$-truncation, we characterize the $n$-\'etale maps as the maps that are right orthogonal to the map $\unit \to \sphere{n+1}$. We prove a `modal flattening lemma' and a `modal descent theorem'. The latter asserts that a $\modal$-\'etale map into a type $X$ is the same thing as a family of modal types over $\modal X$. Furthermore we describe a wide range of applications.
\end{abstract}


\section{Introduction}
\begin{itemize}
\item In 2011 Urs Schreiber and Mike Shulman started to think about the concept of Modalities in Homotopy Type Theory,
  with the idea to use these extended theories to reason about more specialized $(\infty,1)$-toposes.
  One special application they had in mind was to use Homotopy Type Theory to talk about \emph{cohesive} $(\infty,1)$-toposes,
  which is witnessed in the notes \cite{ShulmanSchreiber}.
  This idea of a cohesive type theory was later worked out in \cite{ShulmanRealCohesion}.
  While the applications of the theory in this article are at least close to these ideas,
  we will work with a simpler setup of only one \emph{monadic} modality.
\item Modality is defined in \cite[Section 7.7]{UFP}.
  Modalities where studied extensively in \cite{RijkeSpittersShulman}.
  There are two factorization systems associated to a modality which coincide in the case of a left exact modality,
  we will study one of these factorization systems. The name of maps in the right class is inspired by algebraic geometry -- they are called $\modal$-étale,
  where $\modal$ is the modality.
\item The application \ref{sec:topological_stacks} suggests a new notion of covering space for topological stacks and shows that
  one interpretation of theorem \ref{thm:modal_descent} is an extension of the classcial fundamental theorem of the theory of covering spaces,
  relating covering spaces over a fixed space with certain actions of its fundamental groupoid.
  This expands results of the second author from \cite{wellen-oxford-abstract}.
\item Thanks to (at least) Jonas Frey and Mike Shulman for help in understanding factorization systems in the email discussion.
  ...?
  We gratefully acknowledge the support of the Air Force Office of Scientific Research through MURI grant FA9550-15-1-0053. Any opinions, findings and conclusions or recommendations expressed in this material are those of the authors and do not necessarily reflect the views of the AFOSR.
\end{itemize}

\section{Preliminaries}
We assume the reader is familiar with the basics of homotopy type theory. To the reader who is not familiar with HoTT we recommend \cite{hottbook}.

We make extensive use of homotopy pullbacks. The most important property we will be relying on is the following theorem

\begin{thm}
  Consider a commuting square
  \begin{equation*}
    \begin{tikzcd}
      A \arrow[r,"h"] \arrow[d,swap,"f"] & X \arrow[d,"g"] \\
      B \arrow[r,swap,"i"] & Y
    \end{tikzcd}
  \end{equation*}
  with homotopy $H:i\circ f\htpy g\circ h$. Then the following are equivalent:
  \begin{enumerate}
  \item The square is a pullback square.
  \item For each $b:B$ the induced map on fibers
    \begin{equation*}
      \fib{f}{b} \to \fib{g}{i(b)}
    \end{equation*}
    is an equivalence.
  \end{enumerate}
\end{thm}

For an arbitrary commuting square, the induced map into the pullback is called the \define{gap map}. One can show that the fibers of the gap map are equivalent to the fibers of the induced maps on fibers. This observation implies the above theorem.

The main object of study in this article is a modality, of which the primary examples are the $n$-truncations. There are many equivalent ways of saying what a modality is \cite{RijkeSpittersShulman}. The most convenient definition for our purpose is that of a \emph{stable orthogonal factorization system}, which we recall now.

\begin{defn}
  An orthogonal factorization system is a pair $(\mathcal{L},\mathcal{R})$ of classes of maps
  \begin{align*}
    \mathcal{L} & : \prd{X,Y:\UU} (X \to Y) \to \mathsf{Prop} \\
    \mathcal{R} & : \prd{X,Y:\UU} (X \to Y) \to \mathsf{Prop} 
  \end{align*}
  such that
  \begin{enumerate}
  \item Both $\mathcal{L}$ and $\mathcal{R}$ contain all equivalences and are closed under composition.
  \item Every map $f:X\to Y$ factors as a left map (i.e.~a map in $\mathcal{L}$) followed by a right map (i.e.~a map in $\mathcal{R}$). More precisely, for every map $f:X\to Y$ there is a type $\mathsf{im}_{(\mathcal{L},\mathcal{R})}(f)$ equipped with maps $f_{\mathcal{L}}:X\to \mathsf{im}_{(\mathcal{L},\mathcal{R})}(f)$, $f_{\mathcal{R}}:\mathsf{im}_{(\mathcal{L},\mathcal{R})}(f) \to Y$ and a homotopy witnessing that the triangle
    \begin{equation*}
      \begin{tikzcd}
        X \arrow[rr,"f"] \arrow[dr,swap,"f_{\mathcal{L}}"] & & Y \\
        & \mathsf{im}_{(\mathcal{L},\mathcal{R})}(f) \arrow[ur,swap,"f_{\mathcal{R}}"]
      \end{tikzcd}
    \end{equation*}
    commutes.
  \item Every map in the left class is \define{left orthogonal} to every map in the right class (we also say that every map in $\mathcal{R}$ is right orthogonal to every map in $\mathcal{L}$). Following the observations of \cite{AnelBiedermanFinsterJoyal}, this means that for any map $i:A \to B$ in $\mathcal{L}$ and any map $f:X \to Y$ in $\mathcal{R}$, the square
    \begin{equation*}
      \begin{tikzcd}
        X^B \arrow[r] \arrow[d] & Y^B \arrow[d] \\
        X^A \arrow[r] & Y^A
      \end{tikzcd}
    \end{equation*}
    is a pullback square.
  \end{enumerate}
  An orthogonal factorization system is said to be \define{stable} if the left class is stable under pullbacks. That is, for any pullback square
    \begin{equation*}
      \begin{tikzcd}
        A \arrow[r,"h"] \arrow[d,swap,"f"] & X \arrow[d,"g"] \\
        B \arrow[r,swap,"i"] & Y
      \end{tikzcd}
    \end{equation*}
    in which the map $g:X \to Y$ is in $\mathcal{L}$, it is required that $f$ is also in $\mathcal{L}$. A \define{modality} is defined to be a stable orthogonal factorization system.
\end{defn}

Given a stable orthogonal factorization system, we say that a type $X$ is modal if the terminal projection $X\to \unit$ is in $\mathcal{R}$. 
There is an operation $\modal:\UU\to\UU$ associated to any stable orthogonal factorization, which is often called the modality. It is defined as
\begin{equation*}
\modal X \defeq \mathsf{im}_{(\mathcal{L},\mathcal{R})}(X\to \unit).
\end{equation*}
The left factor $X \to \modal X$ of this factorization is called the \define{modal unit} and is denoted by $\eta:X\to \modal X$. One can show that for any family $P:\modal X \to \UU$ of modal types, the pre-composition map
\begin{equation*}
\blank\circ \eta : \Big(\prd{x:\modal X}P(x)\Big)\to \Big(\prd{x:X}P(\eta(x))\Big)
\end{equation*}
is an equivalence. This property is called the \define{unique elimination principle} for modalities, and modalities can be defined equivalently in terms of the unique elimination principle.

We recall that for any two modalities $(\mathcal{L},\mathcal{R})$ and $(\mathcal{L}',\mathcal{R}')$ the following are equivalent:
\begin{enumerate}
\item Every $(\mathcal{L},\mathcal{R})$-modal type is $(\mathcal{L}',\mathcal{R}')$-modal.
\item The modal units of the modality $(\mathcal{L}',\mathcal{R}')$ are in $\mathcal{L}$.
\end{enumerate}
In particular: for any modality it follows that every proposition is modal if and only if the modal units are surjective.

\section{\texorpdfstring{$\modal$}{○}-\'etale maps}

\begin{defn}
We say that a map $f:A\to B$ is said to be \define{$\modal$-\'etale}, or \define{formally \'etale}, if the square
\begin{equation*}
\begin{tikzcd}
A \arrow[r,"f"] \arrow[d,swap,"\eta"] & B \arrow[d,"\eta"] \\
\modal A \arrow[r,swap,"\modal f"] & \modal B
\end{tikzcd}
\end{equation*}
is a pullback square. We will write
\begin{equation*}
\isetale(f)\defeq\ispullback(f,\eta_A,\natunit_\modal(f)).
\end{equation*}
\end{defn}

It is immediate from the definition that any equivalence is $\modal$-\'etale, and that the $\modal$-\'etale maps are closed under composition.

\begin{eg}\label{eg:etale_prop}
We claim that a map $f:A\to B$ is $\brck{\blank}$-\'etale if and only if $A\to \isequiv(f)$. Examples of maps that satisfy this condition include equivalences, maps between propositions, and any map of the form $\emptyt\to B$.

To see that if $f:A\to B$ is $\modal$-\'etale, then $A\to\isequiv(f)$, consider the pullback square
\begin{equation*}
\begin{tikzcd}
A \arrow[r] \arrow[d,swap,"f"] & \brck{A} \arrow[d,"\brck{f}"] \\
B \arrow[r] & \brck{B},
\end{tikzcd}
\end{equation*}
and let $a:A$. Then both $\brck{A}$ and $\brck{B}$ are contractible, so $\brck{f}:\brck{A}\to\brck{B}$ is an equivalence. Since equivalences are stable under pullback it follows that $f$ is an equivalence.

Now suppose that $A\to \isequiv(f)$. Since $\isequiv(f)$ is a proposition, we also have $\brck{A}\to\isequiv(f)$. To see that the gap map
\begin{equation*}
A \to B\times_{\brck{B}}\brck{A}
\end{equation*}
is an equivalence, we will show that its fibers are contractible. Let $b:B$, $x:\brck{A}$ and $p:\bproj{b}=\brck{f}(x)$. Since $\brck{A}\to\isequiv(f)$, it follows that $f$ is an equivalence. Then $\brck{f}$ is also an equivalence, from which it follows that the naturality square is a pullback square. We conclude that the fibers of the gap map are contractible. 
\end{eg}

\begin{lem}\label{lem:etale_modal}
Any map between $\modal$-modal types is $\modal$-\'etale.
\end{lem}

\begin{proof}
Suppose $f:X\to Y$ is a map between $\modal$-modal types. Then the top and bottom maps in the square
\begin{equation*}
\begin{tikzcd}
X \arrow[r] \arrow[d] & \modal X \arrow[d] \\
Y \arrow[r] & \modal Y
\end{tikzcd}
\end{equation*}
are equivalences. Therefore this square is a pullback square, so $f$ is $\modal$-\'etale.
\end{proof}

In this section our goal is an almost general charachterization of $\modal$-étale maps and using it to characterize the $\modal$-\'etale maps for the $n$-truncations. We call such maps \define{$n$-\'etale}. Note that the case of propositional truncation has already been addressed in \cref{eg:etale_prop}.
The characterization only works if the domain of the map in question has a surjective $\modalunit$.
\begin{defn}
  A map $\varphi:X\to Y$ is surjective, if all its fibers are merely inhabited.
\end{defn}
Note that using the connected-truncated factorization system from \cite{RijkeSpittersShulman}, we can see that all $\modalunit$ are surjective for some modality, if and only if all propositions are modal.
So in case of $\trunc{n}{\_}$ with $n\geq -1$, the characterization always works.

\begin{lem}\label{lem:etale_char}
Let $\modal$ be a modality and $f:A\to B$ such that $\modalunit_A$ is surjective. The following are equivalent:
\begin{enumerate}
\item $f$ is $\modal$-\'etale.
\item The commuting square
\begin{equation*}
\begin{tikzcd}[column sep=large]
A\times_{\modal A} A \arrow[d,swap,"\pi_1"] \arrow[r,"{f\times_{\modal f} f}"] & B\times_{\modal B} B \arrow[d,"\pi_1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{enumerate}
\end{lem}

\begin{proof}
Suppose first that $f$ is $\modal$-\'etale, and consider the commuting cube
\begin{equation*}
\begin{tikzcd}
& A\times_{\modal A} A \arrow[dl] \arrow[d] \arrow[dr] \\
A \arrow[d] & B\times_{\modal B} B \arrow[dl] \arrow[dr] & A \arrow[dl,crossing over] \arrow[d] \\
B \arrow[dr] & \modal A \arrow[from=ul,crossing over] \arrow[d] & B \arrow[dl] \\
& \modal B
\end{tikzcd}
\end{equation*}
Since the top, bottom, and both front squares are pullback squares, it follows that both back squares are pullbacks. This proves that (i) implies (ii).

Now suppose that (ii) holds. Then the map
\begin{equation*}
\fib{\modalunit}{\modalunit(a)}\to \fib{\modalunit}{\modalunit(f(a))}
\end{equation*}
is an equivalence for every $a:A$. Since $\modalunit_A$ is assumed to be surjective, there merely is an $a:A$ such that $\modalunit(a)=t$ for arbitrary $t:\modal A$.
It follows that
\begin{equation*}
\fib{\modalunit}{t}\to \fib{\modalunit}{\modal f(t)}
\end{equation*}
is an equivalence for every $t:\modal A$. Thus it follows that the square
\begin{equation*}
\begin{tikzcd}
A \arrow[d,swap,"\modalunit"] \arrow[r] & B \arrow[d,"\modalunit"] \\
\modal A \arrow[r] & \modal B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{proof}

\begin{comment}%I don't think we need this
\begin{cor}
If $f:A\to B$ is $\modal$-\'etale, then the square
\begin{equation*}
\begin{tikzcd}[column sep=large]
A \arrow[d,swap,"\delta_{\modalunit}"] \arrow[r,"f"] & B \arrow[d,"\delta_{\modalunit}"] \\
A\times_{\modal A} A \arrow[r,swap,"f\times_{\modal f}f"] & B\times_{\modal B} B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{cor}

\begin{proof}
Consider the diagram
\begin{equation*}
\begin{tikzcd}[column sep=large]
A \arrow[d,swap,"\delta_{\modalunit}"] \arrow[r,"f"] & B \arrow[d,"\delta_{\modalunit}"] \\
A\times_{\modal A} A \arrow[d,swap,"\pi_1"] \arrow[r,"{f\times_{\modal f} f}"] & B\times_{\modal B} B \arrow[d,"\pi_1"] \\
A \arrow[r,"f"] & B
\end{tikzcd}
\end{equation*}
The bottom square is a pullback square by \cref{lem:etale_char}, and the outer rectangle is a pullback since both vertical composites are homotopic to the respective identity functions. Therefore the top square is a pullback.
\end{proof}
\end{comment}

\begin{rmk}\label{rmk:-1etale}
In the special case of $(-1)$-truncation, the characterization of \cref{lem:etale_char} asserts that a map $f:A\to B$ is $(-1)$-\'etale if and only if the square
\begin{equation*}
\begin{tikzcd}
A\times A \arrow[d,swap,"\pi_1"] \arrow[r,"{f\times f}"] & B\times B \arrow[d,"\pi_1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square. Phrased differently, we see that a map is $(-1)$-\'etale if and only if the square
\begin{equation*}
\begin{tikzcd}
A^{\sphere{0}} \arrow[d,swap,"\mathsf{ev}_\ast"] \arrow[r,"f^{\sphere{0}}"] & B^{\sphere{0}} \arrow[d,"\mathsf{ev}_\ast"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square.
\end{rmk}

\begin{rmk}
A map $f:A\to B$ is $0$-\'etale if and only if for each $a:A$ the restriction
\begin{equation*}
\begin{tikzcd}
\sm{x:A}\brck{a=x} \arrow[d,swap,"\proj 1"] \arrow[r,densely dotted,"f"] & \sm{y:B}\brck{f(a)=y} \arrow[d,"\proj 1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
of $f$ to the connected component at $a$ of $A$ is an equivalence.

By \cref{lem:etale_char} and the fact that $\eqv{(\tproj{0}{a}=\tproj{0}{x})}{\brck{a=x}}$, it follows that $f$ is $0$-\'etale if and only if the square
\begin{equation*}
\begin{tikzcd}[column sep=huge]
\sm{a,x:A}\brck{a=x} \arrow[d,swap,"\pi_1"] \arrow[r,"\total{\brck{\apfunc{f}}}"] & \sm{b,y:B}\brck{b=y} \arrow[d,"\pi_1"] \\
A \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
is a pullback square. Furhtermore, this square is a pullback if and only if the induced map
\begin{equation*}
\Big(\sm{x:A}\brck{a=x}\Big)\to\Big(\sm{y:B}\brck{f(a)=y}\Big)
\end{equation*}
is an equivalence, for each $a:A$.

We note that a map $f:A\to B$ between pointed connected types is an equivalence if and only if it is an embedding, which happens if and only if $f^{\sphere{1}}:A^{\sphere{1}} \to B^{\sphere{1}}$ is an equivalence. We can use this fact to conclude that a map is $0$-connected if and only if the square
    \begin{equation*}
      \begin{tikzcd}
        A^{\sphere{1}} \arrow[r] \arrow[d] & B^{\sphere{1}} \arrow[d] \\
        A \arrow[r] & B
      \end{tikzcd}
    \end{equation*}
\end{rmk}

These remarks suggest the following theorem.

\begin{thm}
  For any map $f:A\to B$ and any $n\geq -1$, the following are equivalent:
  \begin{enumerate}
  \item The map $f$ is $n$-\'etale.
  \item The map $f$ is right orthogonal to $\unit\to\sphere{n+1}$.
  \end{enumerate}
\end{thm}

\begin{rmk}
  For $n\jdeq -2$ the statement does not make sense, since there is no evaluation map
  $A^{\sphere{-1}}\to A$. On the other hand, it is easy to see that a map is $-2$-\'etale if and only if it is an equivalence.
\end{rmk}


\begin{proof}
  The case of $n\jdeq -1$ is already covered in \cref{rmk:-1etale}, so we assume that $n$ is at least $0$. Furthermore, recall that $f$ is right orthogonal to $\unit\to\sphere{n+1}$ if and only if the commuting square
    \begin{equation}\label{eq:orth}
      \begin{tikzcd}
        A^{\sphere{n+1}} \arrow[r] \arrow[d] & B^{\sphere{n+1}} \arrow[d] \\
        A \arrow[r] & B
      \end{tikzcd}
    \end{equation}
    is a pullback square.

  For the forward direction, suppose $f:A\to B$ is $n$-\'etale, and consider the commuting cube
\begin{equation*}
\begin{tikzcd}
&[-1ex] A^{\sphere{n+1}} \arrow[dl] \arrow[d] \arrow[dr] &[2ex] \\
\trunc{n}{A}^{\sphere{n+1}} \arrow[d] & B^{\sphere{n+1}} \arrow[dl] \arrow[dr] & A \arrow[dl,crossing over] \arrow[d] \\
\trunc{n}{B}^{\sphere{n+1}} \arrow[dr] & \trunc{n}{A} \arrow[d] \arrow[from=ul,crossing over] & B \arrow[dl] \\
& \trunc{n}{B}
\end{tikzcd}
\end{equation*}
In this cube the front right square is a pullback square by the assumption that $f$ is $n$-\'etale. The back left square is an exponent of this pullback square, so it is again pullback. The front left square is a pullback square because its top and bottom map are both equivalences. Therefore we conclude that the back right square is a pullback square, which shows that $f$ is right orthogonal to the map $\unit\to\sphere{n+1}$.

  For the converse, suppose that the square in \cref{eq:orth} is a pullback square. It follows that the (equivalent) square
  \begin{equation*}
    \begin{tikzcd}
      \sm{x:A}\mathsf{Map}_\ast(\sphere{n},\loopspace{A,x}) \arrow[r] \arrow[d] & \sm{y:B} \mathsf{Map}_\ast(\sphere{n},\loopspace{B,y}) \arrow[d] \\
      A \arrow[r] & B
    \end{tikzcd}
  \end{equation*}
is a pullback square.
  Since a square is a pullback square if and only if the top map is a fiberwise equivalence, it follows that the map
  \begin{equation*}
    \mathsf{Map}_\ast(\sphere{n},\loopspace{f,x}):\mathsf{Map}_\ast(\sphere{n},\loopspace{A,x}) \to \mathsf{Map}_\ast(\loopspace{B,f(x)})
  \end{equation*}
  of pointed mapping spaces is an equivalence. To show that $f$ is $n$-\'etale, it is equivalent to show that the square
  \begin{equation*}
    \begin{tikzcd}
      A\times_{\trunc{n}{A}} A \arrow[r] \arrow[d] & B \times_{\trunc{n}{B}} B \arrow[d] \\
      A \arrow[r] & B
    \end{tikzcd}
  \end{equation*}
  is a pullback square, which is equivalent to showing that the induced map
  \begin{equation*}
    D^{n}(f,x):D^{n}(A,x)\to D^{n}(B,f(x))
  \end{equation*}
  on formal discs is an equivalence for each $x:A$. We note that the formal discs are the fibers of the unit $\eta:A \to \trunc{n}{A}$, so they are $n$-connected. It follows immediately that the map $D^{n}(f,x)$ is $(n-1)$-connected. Therefore it suffices to show that $D^{n}(f,x)$ is an $(n-1)$-truncated map.

  Recall that a map $\varphi$ between ($0$-)connected types is $(n-1)$-truncated if and only if $\varphi^{\sphere{n+1}}$ is an equivalence. Using our assumption that $n\geq 0$ we know that the formal discs under consideration are at least connected. Therefore it suffices to show that $(D^{n}(f,x))^{\sphere{n+1}}$ is an equivalence. Now we observe that the square
  \begin{equation*}
    \begin{tikzcd}
      \mathsf{Map}_\ast(\sphere{n+1},D^{n}(A,x)) \arrow[r] \arrow[d] & \mathsf{Map}_\ast(\sphere{n+1},D^{n}(B,f(x))) \arrow[d] \\
      \mathsf{Map}_\ast(\sphere{n+1},(A,x)) \arrow[r] & \mathsf{Map}_\ast(\sphere{n+1},(B,f(x)))
    \end{tikzcd}
  \end{equation*}
  commutes, and has equivalences on both the left and right sides. Moreover, the bottom map is an equivalence by the suspension-loop space adjunction, and the fact that $\mathsf{Map}_\ast(\sphere{n},\loopspace{f,x})$ is an equivalence. We conclude that the top map is an equivalence, which completes the proof.
\end{proof}

\section{Modal descent}

The following theorem can be seen as a `modal flattening lemma'.
\begin{thm}\label{thm:etale_flattening}
Consider a pullback square
\begin{equation*}
\begin{tikzcd}
E' \arrow[d,swap,"{p'}"] \arrow[r,"g"] & E \arrow[d,"p"] \\
B' \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*}
with $H:f\circ p'\htpy p\circ g$, where $E$ and $B$ are modal types. Then the square
\begin{equation*}
\begin{tikzcd}
\modal E' \arrow[r,"\tilde{g}"] \arrow[d,swap,"{\modal p'}"] & E \arrow[d,"p"] \\
\modal B \arrow[r,swap,"\tilde{f}"] & B
\end{tikzcd}
\end{equation*}
is a pullback square, where $\tilde{f}$ and $\tilde{g}$ are the unique extensions of $f$ and $g$ along the modal units of $B'$ and $E'$, respectively.
\end{thm}

\begin{proof}
Consider the diagram
\begin{equation*}
\begin{tikzcd}
E' \arrow[r,"{\mathsf{gap}(p',g,H)}"] \arrow[d,swap,"{p'}"] &[2.5em] \modal B'\times_{B} E \arrow[r,"\pi_2"] \arrow[d,swap,"\pi_1"] & E \arrow[d,"p"] \\
B' \arrow[r,swap,"\modalunit"] & \modal B' \arrow[r,swap,"\tilde{f}"] & B
\end{tikzcd}
\end{equation*}
In this diagram, the square on the right is a pullback by definition, and the outer rectangle is a pullback by assumption, so the square on the left is also a pullback. Therefore the gap map $E'\to \modal B'\times_B E$ is $\modal$-connected. Moreover, since the modal types are closed under pullbacks it follows that $\modal B'\times_B E$ is modal, and therefore it follows that $\pi_2:\modal B'\times_B E\to E$ is a modal map. Therefore the composite
\begin{equation*}
\begin{tikzcd}
E' \arrow[r,"{\mathsf{gap}(p',g,H)}"] &[2.5em] \modal B'\times_{B} E \arrow[r,"\pi_2"] & E 
\end{tikzcd}
\end{equation*}
factors $g$ as a $\modal$-connected map followed by a $\modal$-modal map. Of course, another such factorization is the composite $g\htpy \tilde{g}\circ\modalunit$. Since factorizations are unique, the claim follows.
\end{proof}

Using modal flattening we establish partial left exactness of the modality.

\begin{cor}\label{cor:etale_lex}
Consider a pullback square
\begin{equation*}
\begin{tikzcd}
A' \arrow[d,swap,"{f'}"] \arrow[r] & A \arrow[d,"f"] \\
B' \arrow[r] & B,
\end{tikzcd}
\end{equation*}
where $f$ is assumed to be $\modal$-\'etale. Then the square
\begin{equation*}
\begin{tikzcd}
\modal A' \arrow[d,swap,"{\modal f'}"] \arrow[r] & \modal A \arrow[d,"\modal f"] \\
\modal B' \arrow[r] & \modal B,
\end{tikzcd}
\end{equation*}
is again a pullback square.
\end{cor}

\begin{proof}
Since $f$ is assumed to be $\modal$-\'etale, the square on the right in the diagram
\begin{equation*}
\begin{tikzcd}
A' \arrow[r] \arrow[d,swap,"{f'}"] & A \arrow[r] \arrow[d,swap,"f"] & \modal A \arrow[d,"\modal f"] \\
B' \arrow[r] & B \arrow[r] & \modal B
\end{tikzcd}
\end{equation*}
is a pullback square. Therefore the outer rectangle is a pullback square by the pullback pasting lemma. Now the claim follows from modal flattening \cref{thm:etale_flattening}, using the outer rectangle.
\end{proof}

\begin{cor}\label{cor:etale_pb}
Consider a pullback square
\begin{equation*}
\begin{tikzcd}
E' \arrow[d,swap,"{p'}"] \arrow[r,"g"] & E \arrow[d,"p"] \\
B' \arrow[r,swap,"f"] & B
\end{tikzcd}
\end{equation*} 
and suppose that $p:E\to B$ is $\modal$-\'etale. Then $p':E'\to B'$ is $\modal$-\'etale.
\end{cor}

\begin{proof}
Consider the commuting cube
\begin{equation*}
\begin{tikzcd}
&[-.5ex] E' \arrow[dr] \arrow[d] \arrow[dl] \\
\modal E' \arrow[d] & B' \arrow[dl] \arrow[dr] & E \arrow[dl,crossing over] \arrow[d] \\
\modal B' \arrow[dr] & \modal E \arrow[d] \arrow[from=ul,crossing over] & B \arrow[dl] \\
& \modal B.
\end{tikzcd}
\end{equation*}
The vertical squares on the back right and front right are pullback squares by assumption.
Then it follows from \cref{cor:etale_lex} that the vertical square on the front left is a pullback square.
Therefore the square on the back left is a pullback square by the pullback pasting property.
\end{proof}

\begin{defn}
Let $X$ be a type. We will define an operation
\begin{equation*}
\etmap:\Big(\sm{A:\UU_\modal}A\to\modal X\Big)\to\Big(\sm{Y:\UU}{g:Y\to X}\isetale(g)\Big)
\end{equation*}
\end{defn}

\begin{constr}
Given a map $f:A\to \modal X$ we take the pullback
\begin{equation*}
\begin{tikzcd}
X\times_{\modal X}A \arrow[d,swap,"\pi_1"] \arrow[r,"\pi_2"] & A \arrow[d,"f"] \\
X \arrow[r,swap,"\modalunit"] & \modal X.
\end{tikzcd}
\end{equation*}
Then the map $\pi_1:X\times_{\modal X}A\to X$ is $\modal$-\'etale by \cref{lem:etale_modal,cor:etale_pb}.
\end{constr}

The following is a descent theorem for $\modal$-\'etale maps.

\begin{thm}[Modal descent]\label{thm:modal_descent}
For any modality $\modal$, and any type $X$, the operation
\begin{equation*}
\etmap:\Big(\sm{A:\UU_\modal}A\to\modal X\Big)\to\Big(\sm{Y:\UU}{g:Y\to X}\isetale(g)\Big)
\end{equation*}
is an equivalence.
\end{thm}

\begin{proof}
If $g:Y\to X$ is $\modal$-\'etale, then the square
\begin{equation*}
\begin{tikzcd}
Y \arrow[d,swap,"g"] \arrow[r,"\modalunit"] & \modal Y \arrow[d,"\modal g"] \\
X \arrow[r,swap,"\modalunit"] & \modal X
\end{tikzcd}
\end{equation*}
is a pullback square. Therefore $g:Y\to X$ is in the fiber of $\etmap$ at $\modal g : \modal Y\to\modal X$. 

It remains to show that for any map $f:A\to\modal X$ with modal domain, there is an equivalence $\eqv{A}{\modal (X\times_{\modal X} A)}$ such that the triangle
\begin{equation*}
\begin{tikzcd}
A \arrow[dr,swap,"f"] \arrow[rr,"\eqvsym"] & & \modal (X\times_{\modal X} A) \arrow[dl,"\modal(\etmap(f))"] \\
& \modal X
\end{tikzcd}
\end{equation*}
commutes. To see this, note that both $f\circ \pi_2$ and $\modal(\etmap(f))\circ \modalunit$ factor the same map as a $\modal$-connected map followed by a modal map, so the claim follows from uniqueness of factorizations.
\end{proof}

\begin{cor}
Suppose $P:X\to\UU_\modal$ is a family of modal types such that the projection map $\proj 1:\big(\sm{x:X}P(x)\big)\to X$ is $\modal$-\'etale. Then $P$ has a unique extension
\begin{equation*}
\begin{tikzcd}
X \arrow[d,swap,"\modalunit"] \arrow[r,"P"] & \UU_\modal. \\
\modal X \arrow[ur,densely dotted,swap,"\tilde{P}"] 
\end{tikzcd}
\end{equation*}
It follows that the commuting square
\begin{equation*}
\begin{tikzcd}
\sm{x:X}P(x) \arrow[d,swap,"\proj 1"] \arrow[r] & \sm{t:\modal X}\tilde{P}(t) \arrow[d,"\proj 1"] \\
X \arrow[r,swap,"\modalunit"] & \modal X
\end{tikzcd}
\end{equation*}
is a pullback square. In particular the top map is $\modal$-connected, so this square is in fact a $\modal$-naturality square.
\end{cor}

\section{The reflective factorization system}

In this section we investigate a second factorization system that can be obtained from any modality, of which the right class is the class of $\modal$-\'etale maps. The left class is the class of \emph{$\modal$-equivalences}.

\begin{defn}
We say that a map $f:A\to B$ is an \define{$\modal$-equivalence} if $\modal f:\modal A\to \modal B$ is an equivalence.
\end{defn}

\begin{rmk}
The difference between the notions of $\modal$-equivalences and $\modal$-connected maps is best explained by an example. In the case of $n$-truncation, the $n$-equivalences are precisely the maps that induce isomorphisms on the first $n$ homotopy groups. The $n$-connected maps are the maps that induce isomorphisms on the first $n$ homotopy groups, and moreover induce an epimorphism on the $(n+1)$-st homotopy group. 

We also note that the $n$-equivalences are not stable under pullbacks, whereas the $n$-connected maps are. Consider for instance the pullback square
\begin{equation*}
\begin{tikzcd}
\loopspace {\sphere{n+1}} \arrow[r] \arrow[d] & \unit \arrow[d] \\
\unit\arrow[r] & \sphere{n+1}
\end{tikzcd}
\end{equation*}
Here the map on the right is an $n$-equivalence, since $\sphere{n+1}$ is $n$-connected. However, the map on the left is not an $n$-equivalence, since the $n$-th homotpy group of $\loopspace{\sphere{n+1}}$ is not trivial: it is the $(n+1)$-st homotopy group of $\sphere{n+1}$, which is $\Z$.
\end{rmk}

\begin{defn}
The \define{reflective factorization system} associated to a modality $\modal$ consists of the $\modal$-equivalences as the left class, and the $\modal$-\'etale maps as the right class.
\end{defn}

Our goal in this section is to show that the reflective factorization system associated to a modality is an orthogonal factorization system.

\begin{lem}\label{lem:3for2_mequiv}
The $\modal$-equivalences satisfy the 3-for-2 property: given a commuting triangle
\begin{equation*}
\begin{tikzcd}
A \arrow[rr,"h"] \arrow[dr,swap,"f"] & & B \arrow[dl,"g"] \\
& C,
\end{tikzcd}
\end{equation*}
if any two of $f$, $g$, and $h$ are $\modal$-equivalences, then so is the third.
\end{lem}

\begin{proof}
Apply $\modal$ to the commuting triangle, and use the 3-for-2 property of equivalences.
\end{proof}

\begin{lem}\label{lem:modal_equivalence}
For a map $f : A \to B$ the following are equivalent:
\begin{enumerate}
\item $f$ is an $\modal$-equivalence.
\item For any modal type $X$, the precomposition map
\begin{equation*}
\precomp{f} : (B \to X) \to (A \to X)
\end{equation*}
is an equivalence.
\end{enumerate}
\end{lem}

\begin{proof} 
Suppose first that $f$ is an $\modal$-equivalence, and let $X$ be $\modal$-modal. Then the square
\begin{equation*}
\begin{tikzcd}
X^B \arrow[r,"\precomp{f}"] \arrow[d,swap,"\precomp{\eta}"] & X^A \arrow[d,"\precomp{\eta}"] \\
X^{\modal B} \arrow[r,swap,"\precomp{\modal f}"] & X^{\modal A}
\end{tikzcd}
\end{equation*}
commutes. In this square the two vertical maps are equivalences by the universal property of modalization, and the bottom map is an equivalence since $\modal f$ is an equivalence. Therefore the map $\precomp{f}:X^B\to X^A$ is an equivalence, as desired.

Conversely, assume that $\precomp{f} : X^B \to X^A$ is an equivalence for every $\modal$-modal type $X$. By the square above it follows that $\precomp{\modal f}:X^{\modal B}\to X^{\modal A}$ is an equivalence for every $\modal$-modal type $X$. The fiber of $\modal A^{\modal B}\to \modal A^{\modal A}$ at $\idfunc:\modal A\to \modal A$ is contractible, so we obtain a retraction $g$ of $\modal f$. To see that $g$ is also a section observe that the fiber of $\modal B^{\modal B}\to \modal B^{\modal A}$ at $\modal f$ is contractible. This fiber contains $(\idfunc[\modal B],\refl{\modal f})$. However, we also have an identification $p:\precomp{\modal f}(\modal f\circ g)=\modal f$, since
\begin{equation*}
\precomp{\modal f}(\modal f\circ g)\jdeq (\modal f \circ g)\circ \modal f\jdeq \modal f \circ (g\circ \modal f) = \modal f. 
\end{equation*}
Therefore $(\modal f\circ g,p)$ is in the fiber of $\precomp{\modal f}:\modal B^{\modal B}\to \modal B^{\modal A}$ at $\modal f$. By the contractibility of the fibers it follows that $(\modal f\circ g,p)=(\idfunc[\modal B],\refl{\modal f})$, so it follows that $\modal f\circ g=\idfunc[\modal B]$. In other words, $g$ is both a retraction and a section of $\modal f$, so $\modal f$ is an equivalence.
\end{proof}

\begin{cor}\label{cor:mequiv_mconn}
Every $\modal$-connected map is a $\modal$-equivalence.
\end{cor}

\begin{lem}\label{lem:rfs_factor}
Every map factors as a $\modal$-equivalence followed by a $\modal$-\'etale map.
\end{lem}

\begin{proof}
Consider a map $f:A\to B$, and the diagram
\begin{equation*}
\begin{tikzcd}
A \arrow[ddr,bend right=15,swap,"f"] \arrow[drr,bend left=15,"\modalunit"] \arrow[dr,"\mathsf{gap}" description] \\
& B\times_{\modal B} \modal A \arrow[d,swap,"\pi_1"] \arrow[r,"\pi_2"] & \modal A \arrow[d,"\modal f"] \\
& B \arrow[r,swap,"\modalunit"] & \modal B.
\end{tikzcd}
\end{equation*}
Then $\pi_1:B\times_{\modal B} \modal A\to B$ is a pullback of a map between modal types, so it is $\modal$-\'etale by \cref{cor:etale_pb}. Furthermore, the map $\pi_2:B\times_{\modal B}\modal A\to \modal A$ is a pullback of a $\modal$-connected map, so it is $\modal$-connected. It follows from \cref{cor:mequiv_mconn} that it is a $\modal$-equivalence. Since the modal unit $\modalunit :A\to\modal A$ is also $\modal$-connected, and therefore a $\modal$-equivalence, we obtain by the 3-for-2 property of $\modal$-equivalences established in \cref{lem:3for2_mequiv} that the gap map is also a $\modal$-equivalence.
\end{proof}

We use the notion of orthogonal factorization systems of \cite{RijkeShulmanSpitters}.

\begin{thm}\label{lem:rfs_orthogonal}
  The pair $(\mathcal{L},\mathcal{R})$, where $\mathcal{L}$ is the class of $\modal$-equivalences, and $\mathcal{R}$ is the class of $\modal$-\'etale maps, is an orthogonal factorization system.
\end{thm}

\begin{proof}
  We have already shown that every map factors as a left map followed by a right map. Therefore it suffices to show that the class of $\modal$-equivalences is left orthogonal to the class of $\modal$-\'etale maps.
  
We have to show that for every $\modal$-equivalence $i:A\to B$, and every $\modal$-\'etale map $f:X\to Y$, the square
\begin{equation*}
\begin{tikzcd}
X^B \arrow[r] \arrow[d] & Y^B \arrow[d] \\
X^A \arrow[r] & Y^A
\end{tikzcd}
\end{equation*}
is a pullback square. Consider the commuting cube
\begin{equation*}
\begin{tikzcd}
&[-1ex] X^B \arrow[dl] \arrow[d] \arrow[dr] \\
(\modal X)^B \arrow[d] & X^A \arrow[dl] \arrow[dr] & Y^B \arrow[d] \arrow[dl,crossing over] \\
(\modal X)^A \arrow[dr] & (\modal Y)^B \arrow[from=ul,crossing over] \arrow[d] & Y^A \arrow[dl] \\
& (\modal Y)^A
\end{tikzcd}
\end{equation*}
In this cube the top and bottom squares are pullback by the assumption that $f$ is $\modal$-\'etale and the fact that exponents of pullback squares are again pullback squares. Furthermore, the square in the front left is pullback, because the two vertical maps are equivalences by the assumption that $i:A\to B$ is a $\modal$-equivalence. Therefore we conclude that the square in the back right is also a pullback square, as desired.
\end{proof}

\section{Overview of applications}

So far, we discussed the n-truncations as an example from plain Homotopy Type Theory.
Viewing Homotopy Type Theory as an internal language of ($\infty$,1)-toposes, 
which is crucial for the following,
special features of a particular topos may be introduced into the type theory as a modality.

In \cite{ShulmanRealCohesion} Mike Shulman introduces Real Cohesive Homotopy Type Theory, as a candidate for an internal language
of some special cases of ($\infty$,1)-toposes called \emph{cohesive}, a higher analog 
of Lawvere's axiomatic cohesion \cite{Lawvere07} developed by Urs Schreiber \cite{SchreiberDcct}.
Let us look at a basic example of such a topos, which contains some \emph{topological stacks}.
The objects may have both topological \emph{and} homotopical structure, which are not the same.
As a site, we can use the full subcategory of topological spaces spanned by
\[ \{ \bR^n \vert n\in\bN\}\]
with a topology given by covering collections of open subsets with contractible intersections.
We will call the topos of sheaves on this site with values in $\infty$-groupoids $\Spaces$. 
Theorem \ref{thm:modal_descent} will turn out to tell us in this context, that important parts of the theory of covering spaces of topological spaces hold for a general abstract modality.

Before we go into the details, it should be mentioned that this is not the only possible application of the theorems in this article to Geometry.
The following table lists also examples in Algebraic Geometry and examples involving other modalities on $\Spaces$.
We will provide details and definitions of the relevant categories for the other examples in the following two sections.

\begin{center}
  \begin{tabular}{p{5cm}p{7cm}}
    \toprule
    $\modal$ & $\modal$-étale maps  \\
    \midrule
    $\trunc{n}{\_}$ on $\infty$-groupoids & Maps inducing equivalences on all $n$-connective covers of the codomain \\
    $\Im$ on $\mathrm{Sh}(k\mathrm{-Alg}^\mathrm{op} ,\Zar)$ & Formally étale maps in the sense of \cite{GrothendieckDieudonne}, if domain and codomain are noetherian schemes   \\
    $\Im$ on $\FSGrp$ & Local diffeomorphisms, if domain and codomain are manifolds \\
    $\trunc{1}{\_}\circ\shape$ on $\Spaces$ & Some notion of covering space for topological stacks \\
    $\trunc{n}{\_}\circ\shape$ on $\Spaces$ & Generalization of covering space for topological stacks, where the universal cover is a topological stack with an $n$-connected homotopy type \\
    $\shape$ on $\Spaces$ & Generalization of covering spaces, where the universal cover is a stack with trivial homotopy type \\
    $\sharp$ on $\Spaces$ & Maps where the domain carries the induced topology \\
    \bottomrule
  \end{tabular}
\end{center}
The list is certainly not complete and there are lots of obvious candidate situations that could turn out to be useful applications.
It might even be more fruitful, to apply this theory to a situation where it is more difficult to figure out basic geometric notions.
The second author has hope, that $\Im$-like functors exist in a meaningful way in derived algebraic and differential geometry, non-commutative geometry or algebraic geometry over deeper bases. The $\bA^1$-localization from motivic homotopy theory is certainly a lot like the $\shape$ above, but it is not known so far, how much our theory and modalities in general might help in this case.

\section{Topological stacks}
\label{sec:topological_stacks}
In Real Cohesive Homotopy Type Theory\footnote{As given in \cite{ShulmanRealCohesion}.},
which will just be called Real Cohesion in the following, 
some well behaved topological spaces, like, for example, topological manifolds
are supposed to be included in the theory as they are included in the category $\Spaces$ defined above.
It is important to note, that the types corresponding to these topological spaces
are 0-types in Real Cohesion.
This can lead to confusion with the common explanation for the Identity types in Homotopy Type Theory,
as paths in a space and care has to be taken to separate the concept of equality
and topological paths, i.e. maps $\gamma:\bR\to X$ from the 0-type $\bR$ representing the real line with the euclidean topology.
Let $\bS^{n}$ denote the topological sphere given by
\[ \bS^{n}:\equiv\left\{ (x_1,\dots,x_{n+1})\in\bR^{n+1}\left\vert \sum_{i=1}^{n+1}x_i^2=1\right.\right\}\]
and $\sphere{n}$ the higher inductive type introduced in \cite{UFP}.
The Reals ``$\bR$'' in this definition are, as in \cite{ShulmanRealCohesion}, the \emph{Dedekind Reals},
which are known to coincide with the exernal sheaf $\mathrm{Hom}_{\mathrm{Top}}(\_,\bR)$ in $\Spaces$ and some similar toposes.

For the present work, the shape modality ``$\shape$'' from Real Cohesion is of special interest.
It maps topological spaces to their \emph{homotopy type}, so for example $\shape \bS^{1} =\sphere{1}$ 
and $\shape \bR =1$.


In a 1-topos cohesive over Set, the functor $\Delta\circ\pi_0$ maps a sheaf to the sheaf constantly its set of connected components.
The $\shape$ is a higher analog of this functor that extracts homotopical information on all h-levels, not just level 0.
So if $X$ represents a topological space with a point $\ast: X$, 
then $\shape X$ is also pointed and the n-th homotopy group of $X$ as a topological space 
could be retrieved from its shape 
as $\pi_n(X):\equiv\trunc{0}{\Omega^n(\shape X)}$.

Like $\Delta\circ\pi_0$ reflects into the subcategory of constant sheaves, $\shape$ reflects into the \emph{discrete} types.
Note that ``discrete'' refers to the topological structure of a type, 
not to a property of the $\infty$-groupoid structure given by its identity type.

The equation ``$\shape \bR=1$'' may be viewed as one of the defining properties of $\shape$
-- it can be defined as the nullification-modality\footnote{Or localization at $\bR\to 1$.} at $\bR$.
In Real Cohesion $\shape$ is also a right adjoint.
Let us just assume that it has surjective units and preserves the colimits we need to reason about the homotopy types we are interested in, to keep things simple.

As all modalities, $\shape$ comes with a unit-map $\modalunit_X\colon X \to \shape X$, for any type $X$.
For any two points $x,y: X$ that are joined by a topological path, 
the images $\modalunit_X(x)$ and $\modalunit_X(y)$ are equal in $\shape X$.

From this point on, 
let us assume that each type supposed to represent a topological space comes with a point ``$\ast$''
and for $\ast:X$ let us abbreviate $\sigma_X(\ast)$ with $\ast$.
  
For many modalities, the fibers of their units are interesting.
For $\bS^{1}$, this fiber
\[ \sum_{x:\bS^{1}}\modalunit_{\bS^{1}}(x)=\ast \]
-- or more precisely its projection to $\bS^{1}$ -- turns out to be the universal cover of $\bS^{1}$.
But this works only for spaces with trivial higher homotopy groups. 
For the construction of the universal cover of an arbitrary type, this has to be adjusted:
\[ \widetilde{X}:\equiv \sum_{x\colon X} \trunc{0}{\modalunit_X(x)=\ast}. \]
Note that this amounts to replacing the modality $\shape$ with the modality $\shape_1:\equiv\trunc{1}{\_}\circ\shape$.
To justify calling $\widetilde{X}$ the universal cover of $X$, 
we will define covering spaces relative to a modality and show a universal property.

\begin{defn}
  \begin{enumerate}
  \item Let $\shape_n:\equiv\trunc{n}{\_}\circ\shape$ for $n\in\bN_{-1}$ and $\shape_\infty:\equiv\shape$
  \item A map $f:X\to Y$ is called an \emph{$n$-covering space}, if it is $\shape_n$-étale for $n\in\bN_{-1}\cup\{\infty\}$.
  \item For a pointed type $X$, let
    \[ \widetilde{X}_n:\equiv\sum_{x:X}\modalunit_X(x)=\ast \]
    be the \emph{universal $n$-covering space}, where $\modalunit_X$ is the unit of $\shape_n$ for some $n\in\bN_{-1}\cup\{\infty\}$.
  \end{enumerate}
\end{defn}
The universal $n$-covering spaces are always $n$-covering spaces by lemma \ref{cor:etale_pb} and noticing that they are given as the pullback of $1\to\shape_nX$.
This also shows that $\shape_n \widetilde{X}_n = 1$.

We could assume $X$ and $Y$ to be path connected to be closer to the common definition of covering spaces,
however the definition chosen here turns out to be simpler for the following.

Note that in contrast to the 1-categorical notion, the notion of 1-covering space for topological stacks given by this definition does not coincide with that of locally constant sheaves, since there can be nontrivial such sheaves on a simply connected space\footnote{One example can be derived from the Hopf-fibration ober $\bS^2$.}.
As a general rule, $n$-covering spaces have to be reconstructible from data available in the $n$-truncation of the homotopy type of the base. 

Now, we will take a closer look at 1-covering spaces.
In the classical theory, there is usually a lemma about lifting properties of covering spaces.
In \cite[Proposition 1.33, p. 61]{Hatcher} this takes the following form: \\
\emph{Suppose given a covering space $p:({Y},{y}_0)\to (X,x_0)$ and a map $f:(Z,z_0)\to (X,x_0)$
  with $Z$ path connected and locally path connected.
  Then a lift $\widetilde{f}:(Z,z_0)\to(Y,{y}_0)$ of $f$ exists, iff $f_\ast(\pi_1(Z,z_0))\subset p_\ast(\pi_1({Y},{y}_0))$.} \\
Let us assume we have a map $p:Y\to X$, representing a map between topological spaces.
Now let $Z$ be any type with two maps to $X$ and $\shape_1 Y$.
To analyze if $p$ is a 1-covering space, we can ask if the map $Z\to X$ has a ``lift'' to $Y$.
\begin{equation*}
\begin{tikzcd}
Z\arrow[dr, swap, "f"]\arrow[rr, bend left=30, "\widetilde{f}"]  & Y\arrow[r, "\modalunit"]\arrow[d, "p"] & \shape_1 Y\arrow[d, "\shape_1 p"] \\
& X\arrow[r, "\modalunit"]  & \shape_1 X 
\end{tikzcd}
\end{equation*}
Since $X$ and $Y$ represent topological spaces, we can assume $Z$ to be 0-truncated as well.
In $\Spaces$, the representables are $\mathrm{Hom}(\_,\bR)$ which are isomorphic to open balls.
This means every sheaf in $\Spaces$ is a colimit of open balls and therefore locally path connected. 
So we can assume $Z$ to be locally path connected.

This means, if $p$ internally has the external property of covering spaces cited above from Hatcher's book, we can lift $f:Z\to X$, if $\shape_1 f$ lifts to $\shape_1 Y$.
But the latter is given by factoring $\widetilde{f}$ over $\shape_1 Z$, so we know $p$ is a 1-covering space.
Likewise, the lifting property from Hatcher is a direct consequence of the pullback property. 

The construction of the covering spaces corresponding to a subgroup $H\subseteq \pi_1(X)$ for a path connected $X$,
can be done by applying the delooping construction of \cite{LicataFinster} to the inclusion map of $H$ to get a map $Bi:BH\to\shape_1(X)$ and pulling $Bi$ back along $\modalunit$. In other words, we use that any subgroup $H\subseteq\pi_1(X)$ can be represented by an action of $\pi_1(X)$ on a discrete 0-type
\footnote{This means we use the \emph{homotopical} covering theory of \cite[Section 3.1]{favonia-thesis} 
and \cite[Section 7.1]{ulrik-egbert-floris-groups}}
and therefore a map $BH\to \shape_1X$, with discrete $BH$.

To get the full correspondence for some general type $X$ of actions of the fundamental groupoid of $X$ on sets and covering spaces over $X$,
we can apply theorem \ref{thm:modal_descent} to $\shape_1$ to get:

\begin{thm}
  \begin{enumerate}
  \item Let $X$ be a type. Then the type of 1-covering spaces over $X$ and the type of $\shape_1$-modal dependent types over $\shape_1 X$ are equivalent.
  \item In particular the type of 1-covering spaces with 0-truncated fibers and the type of maps $\shape_1X\to \mathcal U_{\shape_0}$ are equivalent.
  \end{enumerate}
\end{thm}
\begin{proof}
  \begin{enumerate}
  \item This is just lemma \ref{thm:modal_descent} applied to $\shape_1$.
  \item By pullback pasting and surjectivity of $\modalunit_X$, fibers of 1-covering spaces over $X$ are always equivalent to values of the corresponding morphism $\shape_1 X\to \mathcal U_{\shape_1}$ and vice versa.
  \end{enumerate}
\end{proof}

Of course, we have the same correspondence for any $n\in\bN_{-1}\cup\{\infty\}$.
For the modality $\shape$, this correspondence relates $\shape$-covers with 
maps $\shape X\to\mathcal U_{\shape}$.
Since the latter are $\infty$-actions of $\shape X$ on discrete types, this seems to be a very natural variation of the classical correspondence.
The universal cover construction for $\shape$ yields a ``$\shape$-universal cover'' 
which can have both non-discrete topological structure and
non-propositional identity types.
This occurs whenever $\shape X$ is not 1-truncated.
For example, if we assume a type $\bC\bP^\infty$ representing the appropriate topological space,
the $\shape$-universal cover will be a $1$-type over $\bC\bP^\infty$ with identity types merely $S^1$.
The $\shape$-universal cover $\widetilde{X}_\infty$ of a space has always a contractible shape, i.e. $\shape X \simeq 1$.


Similar generalizations of the classical topological correspondence are known on the classical side
for example for cohesive $\infty$-stacks \cite[Section 5.2.7]{SchreiberDcct}.
The second author sees one advantage in the clarity of the type theoretic proofs.

\section{Algebraic and Differential Geometry}

The $\modal$-étale maps for a special modality $\Im$ were already discussed in \cite{wellen-thesis} and \cite{wellen-cartan-geometry}.
One basic topos where a corresponding functor can be defined is given as $\infty$-groupoid valued sheaves on the site $k\mathrm{-Alg}^{\mathrm{op}}_{\mathrm{fp}}$ of finitely presented affine schemes over a field with the Zariski topology. Here, for any $X\in\mathrm{Sh}(k\mathrm{-Alg}^\mathrm{op}_{\mathrm{fp}})$ , the functor $\Im X$ defined pointwise by
\[ (\Im X)(A):\equiv X(A/\sqrt{0})\]
turns out to be a sheaf again. So $\Im$ is an endofunctor on the topos, which we will assume to correspond to a modality $\Im$ internally.
In \cite[Section 4.4]{wellen-thesis} there is a calculation showing that the formally étale maps in the sense of \cite[§ 17]{GrothendieckDieudonne} are included in the $\Im$-étale maps, if we transfer this notion in the empty context to the topos.

Let us look at the characterization of $\Im$-étale maps from lemma \ref{lem:etale_char}.
For a map $f:X\to Y$, the assumption that $\eta_X$ is surjective corresponds to a generalization of formal smoothness of $X$.
The latter is discussed in \cite[Section 4.4]{wellen-thesis}, where the author forgot to take the difference between pointwise surjections and epimorphisms of sheaves into account.
If we assume this holds for $X$, the lemma tells us that $f$ is $\Im$-étale, if and only if, the following is a pullback:
\begin{equation*}
\begin{tikzcd}[column sep=large]
X\times_{\Im X} X \arrow[d,swap,"\pi_1"] \arrow[r,"{f\times_{\Im f} f}"] & Y\times_{\Im Y} Y \arrow[d,"\pi_1"] \\
X \arrow[r,swap,"f"] & Y
\end{tikzcd}
\end{equation*}
In Algebraic Geometry, these pullbacks are called \emph{formal neighborhood of the diagonal} if $X$ represents a noetherian scheme.
A fiber $\pi_1^{-1}(x)$ is a formal disk $\bD_x$ around a point $x:X$.
Formal disks can be defined internally for any modality by the pullback
\begin{equation*}
  \begin{tikzcd}
    \bD_x\arrow[r]\arrow[d] & 1\arrow[d, "\eta_X(x)"] \\
    X \arrow[r] & \Im X
  \end{tikzcd}
\end{equation*}
And the condition that the square above is a pullback is precisely the condition that all induced maps
\[ df_x:\bD_x\to\bD_{f(x)}\]
are equivalences. So a translation of lemma \ref{lem:etale_char} into Algebraic Geometry could read ``A map from a formally smooth space, is formally étale, if and only if, it induces an isomorphism on all formal disks.''.

We will conclude the applications and the article with a more visual reformulation of the lemma, stating roughly, that a map is formally étale, if and only if it is trivial over all formal disks in its image.
Let $f:X\to Y$ be any map, $x:X$, $\tilde{y}:\equiv \eta_Y(f(x))$ and let us look at the following cube:
\begin{equation*}
  \begin{tikzcd}
                        &[-1ex] \eta_X^\ast(\Im f)^{-1}(\tilde{y})\arrow[dr]\arrow[dl]\arrow[d] &                         \\
(\Im f)^{-1}(\tilde{y})\arrow[d] & X\arrow[dr, "f" near start]\arrow[dl, "\eta_X" near start, swap]     & \bD_{f(x)}\arrow[d]\arrow[dl, crossing over]   \\
 \Im X\arrow[dr, "\Im f",swap]  & 1\arrow[d ,"\tilde{y}"]\arrow[from=ul, crossing over] & Y\arrow[dl] \\
          & \Im Y &
  \end{tikzcd}
\end{equation*}
The front squares and the back right square are pullbacks by definition. The left back square is a pullback by pullback-pasting. So all vertical squares are pullbacks.
If $f:X\to Y$ is formally étale, the bottom square is a pullback and therefore, by pullback-pasting the top square is a pullback.
This could be summarized in the statement that for a formally étale $f:X\to Y$ and any $x:X$, we have a pullback square:
\begin{equation*}
  \begin{tikzcd}
    \bD_{f(x)}\times(\Im f)^{-1}(\tilde{y})\arrow[r]\arrow[d] & X\arrow[d, "f"] \\
    \bD_{f(x)} \arrow[r] & Y
  \end{tikzcd}
\end{equation*}
which means that ``a formally étale map is trivialized over any formal disk''.

Let us assume $\eta_X$ is surjective, so we can use lemma \ref{lem:etale_char} to go back.
According to what we established above, it is enough to show, that all $df_x:\bD_x\to \bD_{f(x)}$ are equivalences.
The assumption is, that the top square in the cube above is a pullback.
We can paste the fiber square to the left back square of the cube:
\begin{equation*}
  \begin{tikzcd}
      \pi^{-1}(\ast)\arrow[r]\arrow[d] & \eta_X^\ast(\Im f)^{-1}(\tilde{y})\arrow[r]\arrow[d, "\pi"] & X\arrow[d] \\
      1\arrow[r]                                & (\Im f)^{-1}(\tilde{y})\arrow[r] & \Im X
  \end{tikzcd}
\end{equation*}
So the fiber $\pi^{-1}(\ast)$ is $\bD_x$ by pullback pasting. Now we repaste the left square to the top square:
\begin{equation*}
  \begin{tikzcd}
      \bD_x\arrow[d]\arrow[r] & \eta_X^\ast(\Im f)^{-1}(\tilde{y})\arrow[r]\arrow[d, "\pi"] & \bD_{f(x)}\arrow[d] \\
      1\arrow[r]                                & (\Im f)^{-1}(\tilde{y})\arrow[r] & 1 
  \end{tikzcd}
\end{equation*}
Which gives us a pullback square witnessing that $df_x$ is an equivalence.  

\printbibliography

\end{document}
